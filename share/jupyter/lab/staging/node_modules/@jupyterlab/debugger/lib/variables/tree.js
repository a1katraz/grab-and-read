// Copyright (c) Jupyter Development Team.
// Distributed under the terms of the Modified BSD License.
import { ReactWidget } from '@jupyterlab/apputils';
import { caretDownEmptyIcon } from '@jupyterlab/ui-components';
import { ArrayExt } from '@lumino/algorithm';
import React, { useEffect, useState } from 'react';
import { convertType } from '.';
/**
 * The body for tree of variables.
 */
export class VariablesBodyTree extends ReactWidget {
    /**
     * Instantiate a new Body for the tree of variables.
     * @param options The instantiation options for a VariablesBodyTree.
     */
    constructor(options) {
        super();
        this._scopes = [];
        this._filter = new Set();
        this._service = options.service;
        const model = options.model;
        model.changed.connect(this._updateScopes, this);
        this.addClass('jp-DebuggerVariables-body');
    }
    /**
     * Render the VariablesBodyTree.
     */
    render() {
        return (React.createElement(React.Fragment, null, this._scopes.map(scope => (React.createElement(VariablesComponent, { key: scope.name, service: this._service, data: scope.variables, filter: this._filter })))));
    }
    /**
     * Set the variable filter list.
     */
    set filter(filter) {
        this._filter = filter;
        this.update();
    }
    /**
     * Update the scopes and the tree of variables.
     * @param model The variables model.
     */
    _updateScopes(model) {
        if (ArrayExt.shallowEqual(this._scopes, model.scopes)) {
            return;
        }
        this._scopes = model.scopes;
        this.update();
    }
}
/**
 * A React component to display a list of variables.
 * @param data An array of variables.
 * @param service The debugger service.
 * @param filter Optional variable filter list.
 */
const VariablesComponent = ({ data, service, filter }) => {
    var _a;
    const [variables, setVariables] = useState(data);
    useEffect(() => {
        setVariables(data);
    }, [data]);
    return (React.createElement(React.Fragment, null,
        React.createElement("ul", null, (_a = variables) === null || _a === void 0 ? void 0 : _a.filter(variable => { var _a; return !((_a = filter) === null || _a === void 0 ? void 0 : _a.has(variable.evaluateName)); }).map(variable => {
            const key = `${variable.evaluateName}-${variable.type}-${variable.value}`;
            return (React.createElement(VariableComponent, { key: key, data: variable, service: service, filter: filter }));
        }))));
};
/**
 * A React component to display one node variable in tree.
 * @param data An array of variables.
 * @param service The debugger service.
 */
const VariableComponent = ({ data, service, filter }) => {
    const [variable] = useState(data);
    const [expanded, setExpanded] = useState(null);
    const [details, setDetails] = useState(null);
    const styleName = {
        color: 'var(--jp-mirror-editor-attribute-color)'
    };
    const styleType = {
        color: 'var(--jp-mirror-editor-string-color)'
    };
    const expandable = variable.variablesReference !== 0 || variable.type === 'function';
    const onVariableClicked = async (e) => {
        if (!expandable) {
            return;
        }
        e.stopPropagation();
        const variableDetails = await service.getVariableDetails(variable.variablesReference);
        setExpanded(!expanded);
        setDetails(variableDetails);
    };
    return (React.createElement("li", { onClick: e => onVariableClicked(e) },
        React.createElement(caretDownEmptyIcon.react, { visibility: expandable ? 'visible' : 'hidden', stylesheet: "menuItem", tag: "span", transform: expanded ? 'rotate(0deg)' : 'rotate(-90deg)' }),
        React.createElement("span", { style: styleName }, variable.name),
        React.createElement("span", null, ": "),
        React.createElement("span", { style: styleType }, convertType(variable)),
        expanded && details && (React.createElement(VariablesComponent, { key: variable.name, data: details, service: service, filter: filter }))));
};
